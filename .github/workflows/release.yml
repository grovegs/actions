name: ğŸš€ Release

on:
    workflow_dispatch:
        inputs:
            version-type:
                description: Select the version to increment (major, minor, patch)
                required: true
                default: patch
                type: choice
                options:
                    - major
                    - minor
                    - patch

permissions:
    contents: write

jobs:
    prepare:
        name: Prepare Release
        runs-on: ubuntu-latest
        outputs:
            version: ${{ steps.bump-version.outputs.next-version }}
            changelog-raw: ${{ steps.generate-changelog.outputs.changelog-raw }}
            changelog-markdown: ${{ steps.generate-changelog.outputs.changelog-markdown }}
        steps:
            - name: ğŸ“‚ Checkout Code
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: ğŸ“ Generate Changelog
              id: generate-changelog
              uses: ./.github/actions/generate-changelog

            - name: ğŸ†™ Bump Version
              id: bump-version
              uses: ./.github/actions/bump-version
              with:
                  version-type: ${{ inputs.version-type }}

    release:
        name: Release Platforms
        needs: prepare
        runs-on: ubuntu-latest
        steps:
            - name: ğŸ“‚ Checkout Code
              uses: actions/checkout@v6

            - name: ğŸš€ Publish to GitHub
              id: publish
              uses: ./.github/actions/publish-github
              with:
                  title: "Release v${{ needs.prepare.outputs.version }}"
                  version: "v${{ needs.prepare.outputs.version }}"
                  changelog: ${{ needs.prepare.outputs.changelog-markdown }}
                  github-token: ${{ secrets.GITHUB_TOKEN }}

            - name: ğŸ§¹ Cleanup Failed Release
              if: always() && (steps.publish.outcome == 'failure' || steps.publish.outcome == 'cancelled')
              run: |
                  if git ls-remote --tags origin | grep -q "v${{ needs.prepare.outputs.version }}"; then
                      echo "Deleting tag v${{ needs.prepare.outputs.version }} from remote"
                      git push --delete origin "v${{ needs.prepare.outputs.version }}"
                  else
                      echo "Tag v${{ needs.prepare.outputs.version }} not found on remote, nothing to clean up"
                  fi

            - name: ğŸ“¢ Notify Discord Success
              if: success()
              uses: ./.github/actions/notify-discord
              with:
                  webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
                  title: âœ… ${{ github.event.repository.name }} v${{ needs.prepare.outputs.version }} (${{ github.ref_name }})
                  description: |
                      ${{ needs.prepare.outputs.changelog-markdown }}

                      [View Release](${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ needs.prepare.outputs.version }})
                  color: "3066993"

            - name: ğŸ“¢ Notify Discord Failure
              if: failure()
              uses: ./.github/actions/notify-discord
              with:
                  webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
                  title: âŒ ${{ github.event.repository.name }} v${{ needs.prepare.outputs.version }} (${{ github.ref_name }})
                  description: |
                      Release publication failed.

                      [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
                  color: "15158332"

    cleanup:
        name: Cleanup on Failure
        if: always() && (failure() || cancelled()) && needs.prepare.result == 'success'
        needs: [prepare, release]
        runs-on: ubuntu-latest

        steps:
            - name: ğŸ“‚ Checkout Code
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: ğŸ—‘ï¸ Delete Tag
              run: |
                  git push origin :refs/tags/v${{ needs.prepare.outputs.version }}
