name: ðŸ§ª Tests

on:
    push:
        branches:
            - main
            - develop
    pull_request:
        branches:
            - main
            - develop

permissions:
    contents: read

jobs:
    test-dotnet-actions:
        name: Test .NET Actions
        runs-on: ubuntu-latest
        steps:
            - name: ðŸ“‚ Checkout Code
              uses: actions/checkout@v5

            - name: ðŸ”§ Setup .NET
              uses: ./.github/actions/setup-dotnet
              with:
                  global-json-file: sandbox/ConsoleApplication/global.json

            - name: ðŸ§ª Test .NET Project
              uses: ./.github/actions/test-dotnet
              with:
                  project: sandbox/ConsoleApplication
                  configuration: Debug

            - name: ðŸŽ¨ Format .NET Project
              uses: ./.github/actions/format-dotnet
              with:
                  project: sandbox/ConsoleApplication

            - name: ðŸ—ï¸ Build .NET Project
              uses: ./.github/actions/build-dotnet
              with:
                  project: sandbox/ConsoleApplication
                  configuration: Release
                  version: 1.0.0-test
                  define-symbols: TEST_BUILD

            - name: ðŸ“¦ Pack .NET Project
              id: pack-dotnet
              uses: ./.github/actions/pack-dotnet
              with:
                  project: sandbox/ConsoleApplication
                  configuration: Release
                  version: 1.0.0-test
                  name: ConsoleApplication-test

            - name: âœ… Verify .NET Package
              shell: bash
              run: |
                  PACKAGE_PATH="${{ steps.pack-dotnet.outputs.package }}"

                  if [ -z "${PACKAGE_PATH}" ]; then
                    echo "::error::Package path is empty"
                    exit 1
                  fi

                  if [ ! -f "${PACKAGE_PATH}" ]; then
                    echo "::error::Package file not found: ${PACKAGE_PATH}"
                    exit 1
                  fi

                  echo "âœ… Package verified: ${PACKAGE_PATH}"

    test-godot-actions:
        name: Test Godot Actions
        runs-on: ubuntu-latest
        steps:
            - name: ðŸ“‚ Checkout Code
              uses: actions/checkout@v5

            - name: ðŸ”§ Setup .NET
              uses: ./.github/actions/setup-dotnet
              with:
                  global-json-file: sandbox/GodotApplication/global.json

            - name: ðŸŽ® Setup Godot
              uses: ./.github/actions/setup-godot
              with:
                  global-json-file: sandbox/GodotApplication/global.json
                  target-platforms: Android
                  cache: "true"

            - name: ðŸ§ª Test Godot Project
              uses: ./.github/actions/test-godot
              with:
                  project: sandbox/GodotApplication
                  global-json-file: sandbox/GodotApplication/global.json

    test-unity-actions:
        name: Test Unity Actions
        runs-on: macos-latest
        steps:
            - name: ðŸ“‚ Checkout Code
              uses: actions/checkout@v5

            - name: ðŸ¤– Setup Android
              uses: ./.github/actions/setup-android
              with:
                  java-version: "17"
                  android-packages: "platform-tools platforms;android-34 build-tools;34.0.0 ndk;25.1.8937393"

            - name: ðŸŽ® Setup Unity
              uses: ./.github/actions/setup-unity
              with:
                  project: sandbox/UnityApplication
                  unity-modules: android
                  cache: "true"

    test-android-setup:
        name: Test Android Setup
        runs-on: ubuntu-latest
        steps:
            - name: ðŸ“‚ Checkout Code
              uses: actions/checkout@v5

            - name: ðŸ¤– Setup Android
              uses: ./.github/actions/setup-android
              with:
                  java-version: "17"
                  android-packages: "platform-tools platforms;android-34 build-tools;34.0.0"

    test-xcode-setup:
        name: Test Xcode Setup
        runs-on: macos-latest
        steps:
            - name: ðŸ“‚ Checkout Code
              uses: actions/checkout@v5

            - name: ðŸŽ Setup Xcode
              uses: ./.github/actions/setup-xcode
              with:
                  xcode-version: "16.2"

    test-utility-actions:
        name: Test Utility Actions
        runs-on: ubuntu-latest
        steps:
            - name: ðŸ“‚ Checkout Code
              uses: actions/checkout@v5
              with:
                  fetch-depth: 0

            - name: ðŸ†™ Bump Version
              id: bump-version
              uses: ./.github/actions/bump-version
              with:
                  version-type: patch

            - name: ðŸ“ Generate Changelog
              uses: ./.github/actions/generate-changelog
              with:
                  next-version: ${{ steps.bump-version.outputs.next-version }}

    test-package-actions:
        name: Test Package Actions
        runs-on: ubuntu-latest
        steps:
            - name: ðŸ“‚ Checkout Code
              uses: actions/checkout@v5

            - name: ðŸ“¦ Pack Godot Addon
              id: pack-godot
              uses: ./.github/actions/pack-godot-addon
              with:
                  addon: sandbox/GodotApplication/addons/TestAddon
                  version: 1.0.0-test
                  filename: TestAddon-test

            - name: âœ… Verify Godot Package
              shell: bash
              run: |
                  PACKAGE_PATH="${{ steps.pack-godot.outputs.package }}"
                  MODIFIED_FILES="${{ steps.pack-godot.outputs.modified-files }}"

                  if [ -z "${PACKAGE_PATH}" ]; then
                    echo "::error::Package path is empty"
                    exit 1
                  fi

                  if [ ! -f "${PACKAGE_PATH}" ]; then
                    echo "::error::Package file not found: ${PACKAGE_PATH}"
                    exit 1
                  fi

                  if [ -z "${MODIFIED_FILES}" ]; then
                    echo "::error::Modified files path is empty"
                    exit 1
                  fi

                  if [ ! -f "${MODIFIED_FILES}" ]; then
                    echo "::error::Modified file not found: ${MODIFIED_FILES}"
                    exit 1
                  fi

                  if ! grep -q 'version="1.0.0-test"' "${MODIFIED_FILES}"; then
                    echo "::error::Version not updated in plugin.cfg"
                    exit 1
                  fi

                  echo "âœ… Godot package verified"
                  echo "  Package: ${PACKAGE_PATH}"
                  echo "  Modified: ${MODIFIED_FILES}"

            - name: ðŸ“¦ Pack Unity Package
              id: pack-unity
              uses: ./.github/actions/pack-unity-package
              with:
                  package: sandbox/UnityApplication/Packages/com.test.package
                  version: 2.0.0-test
                  filename: com.test.package-test

            - name: âœ… Verify Unity Package
              shell: bash
              run: |
                  PACKAGE_PATH="${{ steps.pack-unity.outputs.package }}"
                  MODIFIED_FILES="${{ steps.pack-unity.outputs.modified-files }}"

                  if [ -z "${PACKAGE_PATH}" ]; then
                    echo "::error::Package path is empty"
                    exit 1
                  fi

                  if [ ! -f "${PACKAGE_PATH}" ]; then
                    echo "::error::Package file not found: ${PACKAGE_PATH}"
                    exit 1
                  fi

                  if [ -z "${MODIFIED_FILES}" ]; then
                    echo "::error::Modified files path is empty"
                    exit 1
                  fi

                  if [ ! -f "${MODIFIED_FILES}" ]; then
                    echo "::error::Modified file not found: ${MODIFIED_FILES}"
                    exit 1
                  fi

                  if ! grep -q '"version": "2.0.0-test"' "${MODIFIED_FILES}"; then
                    echo "::error::Version not updated in package.json"
                    exit 1
                  fi

                  echo "âœ… Unity package verified"
                  echo "  Package: ${PACKAGE_PATH}"
                  echo "  Modified: ${MODIFIED_FILES}"

    test-dotnet-version-update:
        name: Test .NET Version Update
        runs-on: ubuntu-latest
        steps:
            - name: ðŸ“‚ Checkout Code
              uses: actions/checkout@v5

            - name: ðŸ”§ Setup .NET
              uses: ./.github/actions/setup-dotnet
              with:
                  global-json-file: sandbox/ConsoleApplication/global.json

            - name: ðŸ—ï¸ Build .NET Project
              uses: ./.github/actions/build-dotnet
              with:
                  project: sandbox/ConsoleApplication
                  configuration: Release
                  version: 2.5.7-test

            - name: ðŸ“ Create Test Directory.Build.props
              shell: bash
              run: |
                  cat > Directory.Build.props << 'EOF'
                  <Project>
                    <PropertyGroup>
                      <Version>0.0.0</Version>
                      <AssemblyVersion>$(Version)</AssemblyVersion>
                      <FileVersion>$(Version)</FileVersion>
                      <PackageVersion>$(Version)</PackageVersion>
                    </PropertyGroup>
                  </Project>
                  EOF

            - name: ðŸ“¦ Pack with Directory.Build.props
              id: pack-with-props
              uses: ./.github/actions/pack-dotnet
              with:
                  project: sandbox/ConsoleApplication
                  configuration: Release
                  version: 2.5.7-test
                  name: ConsoleApplication-version-test
                  directory-build-props: Directory.Build.props

            - name: âœ… Verify Version Updates
              shell: bash
              run: |
                  MODIFIED_FILES="${{ steps.pack-with-props.outputs.modified-files }}"

                  if [ -z "${MODIFIED_FILES}" ]; then
                    echo "::error::No modified files reported"
                    exit 1
                  fi

                  echo "Modified files:"
                  echo "${MODIFIED_FILES}"

                  if ! echo "${MODIFIED_FILES}" | grep -q "Directory.Build.props"; then
                    echo "::error::Directory.Build.props not in modified files"
                    exit 1
                  fi

                  if ! grep -q '<Version>2.5.7-test</Version>' Directory.Build.props; then
                    echo "::error::Version not updated in Directory.Build.props"
                    cat Directory.Build.props
                    exit 1
                  fi

                  if grep -q '<AssemblyVersion>2.5.7-test</AssemblyVersion>' Directory.Build.props; then
                    echo "::error::Property reference was replaced (should remain as reference)"
                    cat Directory.Build.props
                    exit 1
                  fi

                  if ! grep -q '<AssemblyVersion>$(Version)</AssemblyVersion>' Directory.Build.props; then
                    echo "::error::Property reference was lost"
                    cat Directory.Build.props
                    exit 1
                  fi

                  echo "âœ… Version update verified correctly"
                  echo "  - <Version> updated to 2.5.7-test"
                  echo "  - Property references preserved"

    test-format-actions:
        name: Test Format Actions
        runs-on: ubuntu-latest
        steps:
            - name: ðŸ“‚ Checkout Code
              uses: actions/checkout@v5

            - name: ðŸ”§ Setup .NET
              uses: ./.github/actions/setup-dotnet
              with:
                  global-json-file: sandbox/ConsoleApplication/global.json

            - name: ðŸŽ¨ Test Format Files Action
              uses: ./.github/actions/format-files
              with:
                  files: "**/*.{yml,yaml,json,md,sh}"
                  ignore-path: ".gitignore"

            - name: ðŸŽ¨ Test Format .NET Action
              uses: ./.github/actions/format-dotnet
              with:
                  project: sandbox/ConsoleApplication

    test-artifact-actions:
        name: Test Artifact Actions
        runs-on: ubuntu-latest
        steps:
            - name: ðŸ“‚ Checkout Code
              uses: actions/checkout@v5

            - name: ðŸ“ Create Test Files
              shell: bash
              run: |
                  mkdir -p test-artifacts/dir1
                  mkdir -p test-artifacts/dir2
                  echo "Test file 1" > test-artifacts/dir1/file1.txt
                  echo "Test file 2" > test-artifacts/dir2/file2.txt
                  echo "Root file" > test-artifacts/root.txt

            - name: ðŸ“¤ Upload Test Artifact
              uses: ./.github/actions/upload-artifact
              with:
                  name: test-artifact
                  path: test-artifacts/**
                  retention-days: 1

            - name: ðŸ§¹ Clean Test Files
              shell: bash
              run: rm -rf test-artifacts

            - name: ðŸ“¥ Download Test Artifact (Custom Path)
              uses: ./.github/actions/download-artifact
              with:
                  name: test-artifact
                  path: downloaded-artifacts

            - name: âœ… Verify Downloaded Files (Custom Path)
              shell: bash
              run: |
                  if [ ! -f "downloaded-artifacts/test-artifacts/dir1/file1.txt" ]; then
                    echo "::error::file1.txt not in custom path"
                    exit 1
                  fi

                  if [ ! -f "downloaded-artifacts/test-artifacts/dir2/file2.txt" ]; then
                    echo "::error::file2.txt not in custom path"
                    exit 1
                  fi

                  if [ ! -f "downloaded-artifacts/test-artifacts/root.txt" ]; then
                    echo "::error::root.txt not in custom path"
                    exit 1
                  fi

                  if [ -f "downloaded-artifacts/test-artifact.meta" ]; then
                    echo "::error::Metadata file should be removed"
                    exit 1
                  fi

                  echo "âœ… Files verified in custom path, metadata removed"

            - name: ðŸ§¹ Clean Downloaded Files
              shell: bash
              run: rm -rf downloaded-artifacts

            - name: ðŸ“¥ Download Test Artifact (Restore Paths)
              uses: ./.github/actions/download-artifact
              with:
                  name: test-artifact

            - name: âœ… Verify Restored Files
              shell: bash
              run: |
                  if [ ! -f "test-artifacts/dir1/file1.txt" ]; then
                    echo "::error::file1.txt not restored"
                    exit 1
                  fi

                  if [ ! -f "test-artifacts/dir2/file2.txt" ]; then
                    echo "::error::file2.txt not restored"
                    exit 1
                  fi

                  if [ ! -f "test-artifacts/root.txt" ]; then
                    echo "::error::root.txt not restored"
                    exit 1
                  fi

                  if [ -f "test-artifacts/test-artifact.meta" ]; then
                    echo "::error::Metadata should not be in restored files"
                    exit 1
                  fi

                  if [ -f "test-artifact.meta" ]; then
                    echo "::error::Metadata should not be in workspace"
                    exit 1
                  fi

                  CONTENT1=$(cat test-artifacts/dir1/file1.txt)
                  CONTENT2=$(cat test-artifacts/dir2/file2.txt)
                  CONTENT3=$(cat test-artifacts/root.txt)

                  if [ "${CONTENT1}" != "Test file 1" ]; then
                    echo "::error::file1.txt wrong content"
                    exit 1
                  fi

                  if [ "${CONTENT2}" != "Test file 2" ]; then
                    echo "::error::file2.txt wrong content"
                    exit 1
                  fi

                  if [ "${CONTENT3}" != "Root file" ]; then
                    echo "::error::root.txt wrong content"
                    exit 1
                  fi

                  echo "âœ… All files verified in original paths, no metadata"

    test-artifact-file-extensions:
        name: Test Artifact File Extensions
        runs-on: ubuntu-latest
        steps:
            - name: ðŸ“‚ Checkout Code
              uses: actions/checkout@v5

            - name: ðŸ“ Create Test Files
              shell: bash
              run: |
                  mkdir -p outputs
                  echo "Report content" > outputs/report.txt
                  echo '{"data": "test"}' > outputs/data.json

            - name: ðŸ“¤ Upload report.txt
              uses: ./.github/actions/upload-artifact
              with:
                  name: report.txt
                  path: outputs/report.txt
                  retention-days: 1

            - name: ðŸ“¤ Upload data.json
              uses: ./.github/actions/upload-artifact
              with:
                  name: data.json
                  path: outputs/data.json
                  retention-days: 1

            - name: ðŸ§¹ Clean Original Files
              shell: bash
              run: rm -rf outputs

            - name: ðŸ“¥ Download report.txt
              uses: ./.github/actions/download-artifact
              with:
                  name: report.txt

            - name: ðŸ“¥ Download data.json
              uses: ./.github/actions/download-artifact
              with:
                  name: data.json

            - name: âœ… Verify File Extension Artifacts
              shell: bash
              run: |
                  if [ ! -f "outputs/report.txt" ]; then
                    echo "::error::report.txt not restored"
                    exit 1
                  fi

                  if [ ! -f "outputs/data.json" ]; then
                    echo "::error::data.json not restored"
                    exit 1
                  fi

                  if [ -f "outputs/report.txt.meta" ] || [ -f "report.txt.meta" ]; then
                    echo "::error::report.txt.meta should be removed"
                    exit 1
                  fi

                  if [ -f "outputs/data.json.meta" ] || [ -f "data.json.meta" ]; then
                    echo "::error::data.json.meta should be removed"
                    exit 1
                  fi

                  REPORT_CONTENT=$(cat outputs/report.txt)
                  DATA_CONTENT=$(cat outputs/data.json)

                  if [ "${REPORT_CONTENT}" != "Report content" ]; then
                    echo "::error::report.txt wrong content"
                    exit 1
                  fi

                  if [ "${DATA_CONTENT}" != '{"data": "test"}' ]; then
                    echo "::error::data.json wrong content"
                    exit 1
                  fi

                  echo "âœ… File extension artifacts verified"
