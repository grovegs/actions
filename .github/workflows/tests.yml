name: ðŸ§ª Tests

on:
    push:
        branches:
            - main
            - develop
    pull_request:
        branches:
            - main
            - develop

permissions:
    contents: read

jobs:
    test-dotnet-actions:
        name: Test .NET Actions
        runs-on: ubuntu-latest

        steps:
            - name: ðŸ“‚ Checkout Code
              uses: actions/checkout@v5

            - name: ðŸ”§ Setup .NET
              uses: ./.github/actions/setup-dotnet
              with:
                  global-json-file: sandbox/ConsoleApp/global.json

            - name: ðŸ§ª Test .NET Project
              uses: ./.github/actions/test-dotnet
              with:
                  project: sandbox/ConsoleApp
                  configuration: Debug

            - name: ðŸŽ¨ Format .NET Project
              uses: ./.github/actions/format-dotnet
              with:
                  project: sandbox/ConsoleApp

            - name: ðŸ—ï¸ Build .NET Project
              uses: ./.github/actions/build-dotnet
              with:
                  project: sandbox/ConsoleApp
                  configuration: Release
                  version: 1.0.0-test
                  define-symbols: TEST_BUILD

            - name: ðŸ“¦ Pack .NET Project
              uses: ./.github/actions/pack-dotnet
              with:
                  project: sandbox/ConsoleApp
                  configuration: Release
                  version: 1.0.0-test
                  filename: ConsoleApp-test

    test-godot-actions:
        name: Test Godot Actions
        runs-on: ubuntu-latest

        steps:
            - name: ðŸ“‚ Checkout Code
              uses: actions/checkout@v5

            - name: ðŸ”§ Setup .NET
              uses: ./.github/actions/setup-dotnet
              with:
                  global-json-file: sandbox/GodotApplication/global.json

            - name: ðŸŽ® Setup Godot
              uses: ./.github/actions/setup-godot
              with:
                  global-json-file: sandbox/GodotApplication/global.json
                  target-platforms: Android
                  cache: true

            - name: ðŸ§ª Test Godot Project
              uses: ./.github/actions/test-godot
              with:
                  project: sandbox/GodotApplication
                  global-json-file: sandbox/GodotApplication/global.json

    test-unity-actions:
        name: Test Unity Actions
        runs-on: macos-latest

        steps:
            - name: ðŸ“‚ Checkout Code
              uses: actions/checkout@v5

            - name: ðŸ¤– Setup Android
              uses: ./.github/actions/setup-android
              with:
                  java-version: 17
                  android-packages: "platform-tools platforms;android-34 build-tools;34.0.0 ndk;25.1.8937393"

            - name: ðŸŽ® Setup Unity
              uses: ./.github/actions/setup-unity
              with:
                  project: sandbox/UnityApplication
                  unity-modules: android
                  cache: true

    test-android-setup:
        name: Test Android Setup
        runs-on: ubuntu-latest

        steps:
            - name: ðŸ“‚ Checkout Code
              uses: actions/checkout@v5

            - name: ðŸ¤– Setup Android
              uses: ./.github/actions/setup-android
              with:
                  java-version: 17
                  android-packages: "platform-tools platforms;android-34 build-tools;34.0.0"

    test-xcode-setup:
        name: Test Xcode Setup
        runs-on: macos-latest

        steps:
            - name: ðŸ“‚ Checkout Code
              uses: actions/checkout@v5

            - name: ðŸŽ Setup Xcode
              uses: ./.github/actions/setup-xcode
              with:
                  xcode-version: "16.2"

    test-utility-actions:
        name: Test Utility Actions
        runs-on: ubuntu-latest

        steps:
            - name: ðŸ“‚ Checkout Code
              uses: actions/checkout@v5
              with:
                  fetch-depth: 0

            - name: ðŸ†™ Bump Version
              id: bump_version
              uses: ./.github/actions/bump-version
              with:
                  version-type: patch

            - name: ðŸ“ Generate Changelog
              uses: ./.github/actions/generate-changelog
              with:
                  next-version: ${{ steps.bump_version.outputs.next-version }}

    test-package-actions:
        name: Test Package Actions
        runs-on: ubuntu-latest

        steps:
            - name: ðŸ“‚ Checkout Code
              uses: actions/checkout@v5

            - name: ðŸ“¦ Pack Godot Addon
              uses: ./.github/actions/pack-godot-addon
              with:
                  addon: sandbox/GodotApplication/addons/TestAddon
                  version: 1.0.0-test
                  filename: TestAddon-test

    test-format-actions:
        name: Test Format Actions
        runs-on: ubuntu-latest

        steps:
            - name: ðŸ“‚ Checkout Code
              uses: actions/checkout@v5

            - name: ðŸ”§ Setup .NET
              uses: ./.github/actions/setup-dotnet
              with:
                  global-json-file: sandbox/ConsoleApp/global.json

            - name: ðŸŽ¨ Test Format Files Action
              uses: ./.github/actions/format-files
              with:
                  files: "**/*.{yml,yaml,json,md,sh}"
                  ignore-path: ".gitignore"

            - name: ðŸŽ¨ Test Format .NET Action
              uses: ./.github/actions/format-dotnet
              with:
                  project: sandbox/ConsoleApp

    test-artifact-actions:
        name: Test Artifact Actions
        runs-on: ubuntu-latest

        steps:
            - name: ðŸ“‚ Checkout Code
              uses: actions/checkout@v5

            - name: ðŸ“ Create Test Files
              shell: bash
              run: |
                  mkdir -p test-artifacts/dir1
                  mkdir -p test-artifacts/dir2
                  echo "Test file 1" > test-artifacts/dir1/file1.txt
                  echo "Test file 2" > test-artifacts/dir2/file2.txt
                  echo "Root file" > test-artifacts/root.txt

            - name: ðŸ“¤ Upload Test Artifact
              uses: ./.github/actions/upload-artifact
              with:
                  name: test-artifact
                  path: test-artifacts/**
                  retention-days: 1

            - name: ðŸ§¹ Clean Test Files
              shell: bash
              run: |
                  rm -rf test-artifacts

            - name: ðŸ“¥ Download Test Artifact (with path)
              uses: ./.github/actions/download-artifact
              with:
                  name: test-artifact
                  path: downloaded-artifacts

            - name: âœ… Verify Downloaded Files (with path)
              shell: bash
              run: |
                  file_count=$(find downloaded-artifacts -type f -name "file-*" | wc -l)
                  if [ "$file_count" -lt 3 ]; then
                      echo "Error: Expected at least 3 files, found $file_count"
                      ls -la downloaded-artifacts/
                      exit 1
                  fi
                  echo "âœ… Found $file_count files in custom path"

            - name: ðŸ§¹ Clean Downloaded Files
              shell: bash
              run: |
                  rm -rf downloaded-artifacts

            - name: ðŸ“¥ Download Test Artifact (restore original paths)
              uses: ./.github/actions/download-artifact
              with:
                  name: test-artifact

            - name: âœ… Verify Restored Files
              shell: bash
              run: |
                  if [ ! -f "test-artifacts/dir1/file1.txt" ]; then
                      echo "Error: file1.txt not restored to original path"
                      find . -name "file1.txt"
                      exit 1
                  fi
                  if [ ! -f "test-artifacts/dir2/file2.txt" ]; then
                      echo "Error: file2.txt not restored to original path"
                      exit 1
                  fi
                  if [ ! -f "test-artifacts/root.txt" ]; then
                      echo "Error: root.txt not restored to original path"
                      exit 1
                  fi
                  echo "âœ… All files verified in original paths"
